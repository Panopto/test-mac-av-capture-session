# Introduction
This README.md file explains an issue which we experienced with our production application in the field occasionally.
I have now strong repro with this test application and report the issue in detail here.

# Summary of the issue
When AVCaptureSession is built with FaceTime HD camera (a.k.a. built-in camera) and build-in microphone and it runs, video samples from the camera suddenly stops delivered to the output after 30-90 minutes from the start. This bad situation continues for 5 to 10 minutes, and then delivery of video samples suddenly resumes after that.

The problem happens with this test application, which does not do any real processing (like encoding) after the samples are delivered to the delegates of AVCaptureVideoDataOutput and AVCaptureAudioDataOutput. Therefor, the root cause is very unlikely that the capture session is stuck because the downstream blocks or any resource is missing.

As far as I examined the console log of this process, the following message is displayed while the video samples are not delivered.
```
(CMIOBaseUnits) [com.apple.cmio:] CMIO_Unit_Synchronizer_Video.cpp:1433:SyncUsingIntegralFrameTiming observing getting frames too quickly by a lot:  3220629866 : 30000 < 3221865482 : 30000 (-41.1872), prev time / dur: 3220628431 : 30000 / 12370505 : 30000 : dropping this frame
```
I do not know what this line means and I am reporting this issue to Apple and requesting the analysis.

# Repro conditions

This happens with some specific MacBook machines, but not all machines. I have 2 reproducible machines locally.

- Macbook Pro (15-inch, 2019) (mac-1)
- MacBook Pro (13-inch, 2016, Four Thunderbolt 3 Ports) (mac-2)

We also got the report of this problem with our product application sporadically in the field for past 2-3 years on different OS versions and hardware models.

Below are the combinations of devices which I tested on the repro machine.

| Video           | Audio               | Repro |
|-----------------|---------------------|-------|
| Facetime camera | Built-in Microphone | Yes   |
| Facetime camera | Logitech camera     | Yes   |
| Logitech camera | Built-in Microphone | No    |
| Facetime camera | Not connected       | No    |

This result tells me that it happens with FaceTime camera, regardless of audio device.
But, it does not happen if FaceTime camera is used by its own without auido device.

# Explaining the output

## [mac1-output.txt](mac1-output.txt)
This is the stdout output from this application.

Both audio and video samples were smoothly delivered up to 1884 seconds from the start. Video samples kept at the intended rate of 30fps.

However, the video samples were not delivered at all after 1884 seconds.

Then, they were suddenly delivered again at 2313 seconds from the start.

## [mac1.log](mac1.log)
This is OS log for this process. Most of the messages were generated by libraries, but not the application itself.

It started at 14:05:19. The duration when the video frames were not delivered was between 14:36:46 and 14:43:53.

During this period, the following messages were continuously generated.
```
(CMIOBaseUnits) [com.apple.cmio:] CMIO_Unit_Synchronizer_Video.cpp:1433:SyncUsingIntegralFrameTiming observing getting frames too quickly by a lot:  3220630866 : 30000 < 3221865482 : 30000 (-41.1539), prev time / dur: 3220628431 : 30000 / 12370505 : 30000 : dropping this frame

(CMIOBaseUnits) [com.apple.cmio:] CMIO_Unit_Synchronizer_Video.cpp:1468:SyncUsingIntegralFrameTiming here's the normal bounding info:  3220630866 : 30000 < 3226813684 : 30000 (-206.0939), prev time / dur: 3220628431 : 30000 / 12370505 : 30000 : dropping this frame
```

Outside of this period, i.e. when the video samples were correctly delivered, CMIO still generated some messages, but it is different and much less frequent.
```
(CMIOBaseUnits) [com.apple.cmio:] CMIO_Unit_Synchronizer_Video.cpp:1444:SyncUsingIntegralFrameTiming getting frames too quickly, but pretending (9):  3210436926 : 30000 < 3210436931 : 30000 (-0.0002), prev time / dur: 3210436431 : 30000 / 1000 : 30000 : dropping this frame

(CMIOBaseUnits) [com.apple.cmio:] CMIO_Unit_Synchronizer_Video.cpp:1459:SyncUsingIntegralFrameTiming observing getting frames too quickly:  3210437926 : 30000 < 3210437931 : 30000 (-0.0002), prev time / dur: 3210437431 : 30000 / 1000 : 30000 : dropping this frame
```

## Logs from another device
I also attach [mac2-output.txt](mac2-output.txt) and [mac2.log](mac2.log). This is the same problem on another machine. It is basically as same as above case. I will skip explaining the details.
